/*
  ==============================================================================

    This file was auto-generated by the Introjucer!

    It contains the basic startup code for a Juce application.

  ==============================================================================
*/

#include "HiReSamAudioProcessor.h"
#include "HiReSamAudioProcessorEditor.h"


//==============================================================================
HiReSamAudioProcessorEditor::HiReSamAudioProcessorEditor (HiReSamAudioProcessor* ownerFilter)
    : AudioProcessorEditor (ownerFilter),
      spectroscope(11), // FFT Size of 2^11 = 2048
      renderThread("FFT Render Thread")

{
    // The plugin's initial editor size.
    setSize (900, 500);
    
    getProcessor()->sampleRate.addListener (this);
    // The sampleRate has already been set in the HiReSamAudioProcessor before
    // the creation of the HiReSamAudioProcessorEditor.
    // Because of this, the valueChanged is enforced here, such that the
    // sampleRate is also initially transmitted to everyone who needs to know.
    valueChanged (getProcessor()->sampleRate);
    
    renderThread.addTimeSliceClient (&spectroscope);
    renderThread.startThread (3);
    
    addAndMakeVisible (&spectroscope);
    addAndMakeVisible (&pitchDetector);
    addAndMakeVisible (&frequencyCaptions);
}

HiReSamAudioProcessorEditor::~HiReSamAudioProcessorEditor()
{
    getProcessor()->sampleRate.removeListener (this);
    
    renderThread.removeTimeSliceClient (&spectroscope);
    renderThread.stopThread (500);
}

//==============================================================================
void HiReSamAudioProcessorEditor::paint (Graphics& g)
{
//    g.fillAll (Colours::white);
//    g.setColour (Colours::black);
//    g.setFont (15.0f);
//    g.drawFittedText ("Zviel Arbet? HiRe sam@klangfreund.com!",
//                      0, 0, getWidth(), getHeight(),
//                      Justification::centred, 1);
}

void HiReSamAudioProcessorEditor::resized()
{
    int heightForFrequencyCaptions = 20;
    spectroscope.setBounds (0, 0, getWidth(), getHeight() - heightForFrequencyCaptions);
    pitchDetector.setBounds (spectroscope.getBounds());
    frequencyCaptions.setBounds (0, getHeight() - heightForFrequencyCaptions,
                                 getWidth(), heightForFrequencyCaptions);
}

void HiReSamAudioProcessorEditor::valueChanged (Value & value)
{
    if (value.refersToSameSourceAs (getProcessor()->sampleRate))
    {
        spectroscope.setSampleRate (getProcessor()->sampleRate.getValue());
        pitchDetector.setSampleRate (getProcessor()->sampleRate.getValue());
        frequencyCaptions.setSampleRate (getProcessor()->sampleRate.getValue());
    }
}

HiReSamAudioProcessor* HiReSamAudioProcessorEditor::getProcessor() const
{
    return static_cast <HiReSamAudioProcessor*> (getAudioProcessor());
}
